# 3G4 Medical Imaging and Computer Graphics[^1]
[^1]:Created by: Tom Xiaoding  Lu on 01/02/19
## I. Medical Image Acquisition
### 1. Ultrasonic Imaging
#### **Basic Principle**
  * Ultrasound waves are generated by **piezoelectric crystals** which vibrates in an electric field
  * Its vibration when coupled to the patient's skin, spreads to the tissue
  * The vibration spreads to surrounding tissue particles, can be viewed as a propagation longitudinal pressure wave:![Capture](/assets/Capture_g58hgp9um.PNG)
  * The sound waves from a hand-held transducer propagate into the patient undergoing attenuation, diffraction, scattering, refraction and reflection
  * The probe also acts as a detector, the reflected intensity can be plotted against depth resulting in an **A-line** which is a 1D line
  ![Capture](/assets/Capture_tkcnmekc2.PNG)
  * By sweeping the ultrasound beam across a plane, and stacking the **A lines**, a 2D **B-Scan** is constructed with excellent temporal resolution of **70-80 B scans per second**
  ![Capture](/assets/Capture_9nd9a4n49.PNG)
  A: caused by **attenuation**
  S: **Speckle pattern** due to scattering
  R: Clear boundaries caused by **specular reflection and refraction**
#### **Image Construction**
  - **Filtering** removes high frequency noise
  - **Envelope detection** removes the uninteresting radio frequency oscillations
  - **Time gain compensation** corrects for attenuation
  - **Log compression** compensates for large amplitude difference between specular and scatter reflections
  <img src="/assets/Capture_ps3l4qv0g.PNG" width="500">

#### **Doppler Imaging and M Mode Imaging**
  - A Doppler ultrasound is used to estimate the blood flow through your blood vessels  
  - **Pulsed wave (PW)** Doppler measures the velocity at a particular location by **firing a short sequence of pulses along the same line** and looks at the phase differences between the received signals
  - Suffer from inferior spatial and temporal resolution
  - **M-mode imaging**: instead of sweeping the beam across the B-scan plane, a single A-line is scanned repeatedly, generating a 1D image displayed against time
  ![Capture](/assets/Capture_t4oupqc91.PNG)

#### **Adiabatic compressibility:**
The sound speed is given by $c_0 = \sqrt{1/\rho_0\beta_{s0}}$ where $\beta_s$ is the adiabatic compressibility defined as:
$$
\beta_s = \dfrac{1}{\rho}\left(\dfrac{\partial \rho}{\partial p}\right)
$$
Which is the fractional change in density per unit increase in pressure acting on it. **i.e. The easier it is to squish something, the greater its compressibility**, **Ultrasound scanners assume average speed of 1540ms^-2**

#### **Attenuation, Specular reflection and refraction**
  - Attenuation:
    - Mainly due to medium's viscosity which converts acoustic energy to heat
    - If the wave has amplitude $A_z$ and $A_0$ at propogation distances $z, 0$ respectively then:
    $$A_z = A_0 e^{-\alpha z} = A_0 e^{-\alpha_0 f^n z}$$
    - The attenuation coefficient $\alpha$ is therefore $\dfrac{\ln (A_0/A_z)}{z}$
    - At imaging frequencies, most tissues have an $\alpha$ that is proportional to frequency $(n=1)$.
  - Specular reflection and refraction:
    - Consider case below where there is a wave travelling from medium 1 to medium 2:
    <img src="/assets/Capture_fv88vzkck.PNG" width="500">
    Define specific acoustic impedance $Z$ in each material as $$Z_1 = \rho_1c_1 \qquad \qquad Z_2 = \rho_2c_2$$
    - To relate the **power** in the incident, reflected and transmitted waves, the intensity reflection coefficient is $$R = \dfrac{I_r}{I_i} = \left(\dfrac{Z_2-Z_1}{Z_2+Z_1}\right)^2$$
    - The transmission coefficient is $$T = 1-R = \dfrac{4Z_1Z_2}{(Z_2+Z_1)^2}$$
    - Reflection and refraction example, how much of a 1MHz pulse makes it back to the probe, assume a 1cm layer of fat, 3cm of muscle then bone:
    <img src="/assets/Capture_2jc6scnee.PNG" width="500">
    Starting with one unit of intensity, 1cm fat means a drop of 0.63dB hence a factor of $10^{-0.63/10}=0.865$ of the original left.
    Fat to muscle boundary has $T = \dfrac{4\times 1.38 \times 1.70 }{(1.48 + 1.70 )^2} = 0.989$. So, 0.856 of the original is left.
    3cm of muscle at 1.2dB/cm so 3.6dB corresponding to 0.437, so 0.373 of the original is left.
    Muscle to bone has $R = 0.227$ so 0.085 is reflected back
    The 3cm of muscle again causes a drop of 0.437 leaving 0.037 of original intensity
    Keep working backwards, we get in total 0.032 of the original intensity gets back
    ![Capture](/assets/Capture_zyyuxfcz1.PNG)
#### **Axial Resolution**
  - Denote $w$ as the pulse width of the ultrasound, the axial resolution of an ultrasound image is $w/2$
  - This is because we must transmit at least one cycle, $w$ increases with low frequency probes, so low frequency probes have worse axial resolution although penetrates further
#### **Lateral Resolution**
  - A single element transducer usually has a wide field of view, making it impossible do distinguish between these reflectors by using the RF data collected by the transducer.
  - One way is to narrow the field of view to smaller area is through the use of physical lenses
  - A second way is to narrow the field of view is through the use of multiple transducers, fired at once.
  - The RF data collected by each transducer below shows a pulse at a different time, these are called **pre-beam forming RF data**, to focus the recieved data, these pre-beam forming data are shifted in time so the pulses are matched, and signals added
  <img src="/assets/Capture_8xzn42cye.PNG" width="600">
  <img src="/assets/Capture_zkseexi42.PNG" width="600">

   - However, we do not know where the reflector is (otherwise we wouldn't be imaging it). They key is we can focus **the pre beam forming RF data on a specific point in space**, i.e. adjust the delays that correspond to a specific distance. Then any thing that is imaged which is not in focus come up as a blury signal, only things that are in focus have strong signals
   - Ideally we would like to focus the data at all points in the image, one point at a time, focusing the ultrasound data at all points throughout the image is called **dynamic receive focusing** and require high memory, bandwidth and processing ability.
#### **Elevational Resolution**
 <img src="/assets/Capture_jacoc1v1f.PNG" width="450">

#### **Scattering and speckle**
  - Reflections do not only occur at material boundaries, **individual tissues are inhomogeneous**, there are small, local vibrations of density and compressibility which give rise to **scatter reflections which show up as speckle** in B-scans
  - The smallest inhomogeneity is called a point scatter which **transmits the incident wave in all directions**. The waves which head back towards the probe, contributing to the speckle pattern are called backscatter
  <img src="/assets/Capture_jn5tn3k8x.PNG" width="500">

#### **Three dimensional ultrasound**
  - **Oscillating head probes**: a conventional probe is mounted on a stepper motor, positionally accurate and produce evenly sampled volumes which can be resliced. However they can acquire **only a fixed size, rather small volume**
  <img src="/assets/Capture_nha3tqx20.PNG" width="500">

  - **2D phase array transducers**: A 2D array of crystals steers the beam across a pyramid shaped volume instead of a single B-scan plane, cabling and A/D conversion is difficult
  - **Freehand scanning**: A conventional probe is manually swept over the area of interest, while its position is tracked using either an add on optical tracker or by analyzing the B-scan sequence. The clinician can choose the scanning pattern to best suit the acoustic window, however the position sensor needs careful calibration and poses an interesting re-slicing problem.
  <img src="/assets/Capture_l3j3x5969.PNG" width="500">

### 2. Imaging with X-rays
#### **X-ray generation:**
  - The **electrons strike the anode** with energy $E_0$eV where $E_0$ is the potential difference between the anode and the cathode. **Less than 1% of the electron energy goes into the X-rays**.
  - The rest heats the tungsten which has a high melting point, it also usually rotates so the heat can be dissipated more effectively
  ![Capture](/assets/Capture_twaun4o09.PNG)
  - There are two mechanisms for producing X-rays, the breaking radiation and the characteristic radiation. Figure below illustrates the breaking radiation where the electron is decelerated in a discrete number of interactions with the tungsten atoms, releasing a gamma photon at each interaction
  <img src="/assets/Capture_z8bjpb6ey.PNG" width="300">
  - If the incident electron have enough energy to **displace electrons from the inner shell of the tungsten atoms (about 70eV)** additional spectral peaks are observed.
  - The two phenomena are summarized by the picture below
  <img src="/assets/Capture_1z4mj3pyy.PNG" width="400">
  - **Beam hardening** is used in clinical radiology as the superficial absorption of softer photons serves only to distort the output of the imaging system. It is therefore normal to **place a filter of aluminum or copper between the X-ray tube and the subject which reduces the amplitude of soft X-rays.**
#### **X-ray attenuation**
  As a streame of X-ray photons of intensity I and energy E passes through a homogeneous medium of thickness $x$, they are attenuated : $$I = I_0e^{-\mu x}$$
  - **Attenuation through Compton Scattering (undesirable)**
    - Happens when X-ray photons have relatively low energy
    - A photon collides with a weakly bound outer shell electron, which escapes from the atom with some kinetic energy
    - The remaining energy is carried away by a scattered X-ray photon.
    <img src="/assets/Capture_shv60mxuz.PNG" width="400">
  - **Attenuation through Photoelectric absorption (useful)**
    <img src="/assets/Capture_eyvjb0kgz.PNG" width="400">
    - The energy of the X-ray photon is completely absorbed as it ejects an electron from an inner shell.
    - The excess energy of the photon is carried off as kinetic energy by the ejected electron.
    - Lower energy characteristic radiation is emitted in the same direction as the original photon

  Figure below shows the effect of Compton scattering and photoelectric effect
  ![Capture](/assets/Capture_tdk0c9go2.PNG)
  If the attenuation medium compsiese a number of different substances with individual values of $\mu$ the overall attenuation is therefore
  $$I = I_0e^{- \sum_i \mu_i \Delta x_i} = I_0 e^{-\int_{x_0}^{x_1}\mu(x)dx}$$
  For discrete and continuous material respectively.
#### X ray detection
* **Screen-film detector**
  - Emulsion is gelatin in which tiny crystals of silver bromide are suspended
  - **3-10% of the X-ray energy is absorbed by the emulsion**, sensitivity is increased by a factor of 10-40 by intensifying screens
  - The intensifying screen fluoresce when stimulated by X-rays, producing **ultra-violet light**
  - Film has to be developed before the image can be seen
  - **Has to be developed before the image can be seen**
  ![Capture](/assets/Capture_ibq34v9b3.PNG)
- **Scintillation crystal photomultiplier coupled detector**
  - The scintillation material produces **flashes of light** as X-rays are absorbed by Compton Scattering
  - These flashes are **amplified millions of times** to produce a current output
  - The output voltage is proportional to the energy of incoming X-ray photon
  - **Fast, high efficiency but low packing density**, used in current NMR scanners
  ![Capture](/assets/Capture_nrm61c7bf.PNG)

#### X-ray computer tomography
- **Radon Transform**
  - Consider a circle of material defined by $\mu(x,y)$ which we wish to measure. Projection beams defined by the coordinate system $s, l$ which is at an angle $\phi$ relative to the $x,y$ coordinates. We call the intensity profile of the beams **at a angle $\phi$** which gets attenuated by the circle $I_{\phi}(s)$: $$I_\phi (s) = I_0 e^{-\int_{-\infty} ^ {+\infty} \mu(x,y) dl}$$
  ![Capture](/assets/Capture_osw6ungr0.PNG)
  - We can transform the intensity profile into an attenuation profile $p_\phi (s)$ which is the amount absorbed by the material: $$p_\phi (s) = -\ln \dfrac{I_{\phi}(s)}{I_0}$$
  ![2](/assets/2_c910jksc7.PNG)
  - Performing coordinate transform through noting that $$s = \cos(\phi)x + \sin(\phi) y$$ $$l = -\sin(\phi) x + \cos(\phi) y$$
  - We can write $$p_\phi (s) = \int_{-\infty}^{\infty} \mu(s\cos\phi - l\sin\phi, s\sin\phi + l\cos\phi)dl$$
  - Now, if we take the full set of projections at different angles, we can stack the resulting $p_\phi(s)$ into a 2D dataset $p(s,\phi)$ called a **sinogram**:
  ![3](/assets/3.PNG)
  - The transform from $\mu(x,y)$ to $p(s, \phi)$ is called the **Radon transform**: $$p(s,\phi) = \mathcal{R}[\mu(x,y)] = \int_{-\infty}^{\infty} \mu(s\cos\phi - l\sin\phi, s\sin\phi + l\cos\phi)dl$$
  - The radon transform maps an image to its projection profiles through all angles, a projection profile is defined by integrating the image along the line of projection
  - For CT reconstruction, we need to find a way of inverting the Radon transform:$$\mu (x,y) = \mathcal{R}^{-1}[p(s,\phi)]$$
- **Inverse Radon Transform Via Fourier Transform**
  - Consider the 1D Fourier transform of the projection data $$\mathcal{F}_1(\omega)[p_\phi(s)] = \int_{-\infty}^{\infty} p_\phi(s) e^{-i\omega s}ds$$ $$ = \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} \mu(s\cos\phi - l\sin\phi, s\sin\phi + l\cos\phi)e^{-i\omega s}dlds$$
  - Transforming the coordinates from $(s,l)$ to $(x,y)$ (noting Jacobian of transformation is 1) gives $$\mathcal{F}_1(\omega)[p_\phi(s)] = \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} \mu(x,y) e^{-i \omega(xcos\phi +y\sin \phi)}dxdy$$
  - The 2D Fourier transform is defined as $$\mathcal{F}[\mu(x,y)] = \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} \mu(x,y) e^{-i(\omega_x x + \omega_y y)}dxdy $$
  - Comparing the two expressions, we see that $$\mathcal{F}_1(\omega)[p_\phi(s)]  = \mathcal{F}[\mu(x,y)]$$ where $\omega_x = \omega\cos(\phi), \; \omega_y = \omega\sin(\phi)$. In other words, the 1D Fourier transform of the projection data at a given projection angle (a slice in sinogram) is the same as the radial data passing through the origin in the 2D Fourier transform of the attenuation data $\mu(x,y)$
  - Therefore the **Direct Fourier reconstruction** algorithm goes as follows:
    - 1. Take n projections $p_\phi(s)$ of the object
    - 2. Find 1D Fourier transforms of the projections
    - 3. Use the set of 1D Fourier transforms to tile the spatial frequency plane. Each transform contributes a radial strip $(\omega, \phi)$, for a particular angle $\phi$, passing through the origin.
    - 4. Resample this data to produce a regular sampling of the spatial frequency plane
    - 5. Take the 2D inverse Fourier transform
